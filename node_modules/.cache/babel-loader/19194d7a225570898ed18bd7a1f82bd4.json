{"ast":null,"code":"import { createVNode as _createVNode, mergeProps as _mergeProps } from \"vue\"; // Styles\n\nimport \"./VMenu.css\"; // Components\n\nimport { VDialogTransition } from \"../transitions/index.js\";\nimport { VDefaultsProvider } from \"../VDefaultsProvider/index.js\";\nimport { VOverlay } from \"../VOverlay/index.js\";\nimport { makeVOverlayProps } from \"../VOverlay/VOverlay.js\"; // Composables\n\nimport { forwardRefs } from \"../../composables/forwardRefs.js\";\nimport { useRtl } from \"../../composables/locale.js\";\nimport { useProxiedModel } from \"../../composables/proxiedModel.js\";\nimport { useScopeId } from \"../../composables/scopeId.js\"; // Utilities\n\nimport { computed, inject, mergeProps, nextTick, onBeforeUnmount, onDeactivated, provide, ref, shallowRef, useId, watch } from 'vue';\nimport { VMenuSymbol } from \"./shared.js\";\nimport { focusableChildren, focusChild, genericComponent, getNextElement, IN_BROWSER, isClickInsideElement, omit, propsFactory, useRender } from \"../../util/index.js\"; // Types\n\nexport const makeVMenuProps = propsFactory({\n  // TODO\n  // disableKeys: Boolean,\n  id: String,\n  submenu: Boolean,\n  ...omit(makeVOverlayProps({\n    closeDelay: 250,\n    closeOnContentClick: true,\n    locationStrategy: 'connected',\n    location: undefined,\n    openDelay: 300,\n    scrim: false,\n    scrollStrategy: 'reposition',\n    transition: {\n      component: VDialogTransition\n    }\n  }), ['absolute'])\n}, 'VMenu');\nexport const VMenu = genericComponent()({\n  name: 'VMenu',\n  props: makeVMenuProps(),\n  emits: {\n    'update:modelValue': value => true\n  },\n\n  setup(props, _ref) {\n    let {\n      slots\n    } = _ref;\n    const isActive = useProxiedModel(props, 'modelValue');\n    const {\n      scopeId\n    } = useScopeId();\n    const {\n      isRtl\n    } = useRtl();\n    const uid = useId();\n    const id = computed(() => props.id || `v-menu-${uid}`);\n    const overlay = ref();\n    const parent = inject(VMenuSymbol, null);\n    const openChildren = shallowRef(new Set());\n    provide(VMenuSymbol, {\n      register() {\n        openChildren.value.add(uid);\n      },\n\n      unregister() {\n        openChildren.value.delete(uid);\n      },\n\n      closeParents(e) {\n        setTimeout(() => {\n          if (!openChildren.value.size && !props.persistent && (e == null || overlay.value?.contentEl && !isClickInsideElement(e, overlay.value.contentEl))) {\n            isActive.value = false;\n            parent?.closeParents();\n          }\n        }, 40);\n      }\n\n    });\n    onBeforeUnmount(() => {\n      parent?.unregister();\n      document.removeEventListener('focusin', onFocusIn);\n    });\n    onDeactivated(() => isActive.value = false);\n\n    async function onFocusIn(e) {\n      const before = e.relatedTarget;\n      const after = e.target;\n      await nextTick();\n\n      if (isActive.value && before !== after && overlay.value?.contentEl && // We're the topmost menu\n      overlay.value?.globalTop && // It isn't the document or the menu body\n      ![document, overlay.value.contentEl].includes(after) && // It isn't inside the menu body\n      !overlay.value.contentEl.contains(after)) {\n        const focusable = focusableChildren(overlay.value.contentEl);\n        focusable[0]?.focus();\n      }\n    }\n\n    watch(isActive, val => {\n      if (val) {\n        parent?.register();\n\n        if (IN_BROWSER) {\n          document.addEventListener('focusin', onFocusIn, {\n            once: true\n          });\n        }\n      } else {\n        parent?.unregister();\n\n        if (IN_BROWSER) {\n          document.removeEventListener('focusin', onFocusIn);\n        }\n      }\n    }, {\n      immediate: true\n    });\n\n    function onClickOutside(e) {\n      parent?.closeParents(e);\n    }\n\n    function onKeydown(e) {\n      if (props.disabled) return;\n\n      if (e.key === 'Tab' || e.key === 'Enter' && !props.closeOnContentClick) {\n        if (e.key === 'Enter' && (e.target instanceof HTMLTextAreaElement || e.target instanceof HTMLInputElement && !!e.target.closest('form'))) return;\n        if (e.key === 'Enter') e.preventDefault();\n        const nextElement = getNextElement(focusableChildren(overlay.value?.contentEl, false), e.shiftKey ? 'prev' : 'next', el => el.tabIndex >= 0);\n\n        if (!nextElement) {\n          isActive.value = false;\n          overlay.value?.activatorEl?.focus();\n        }\n      } else if (props.submenu && e.key === (isRtl.value ? 'ArrowRight' : 'ArrowLeft')) {\n        isActive.value = false;\n        overlay.value?.activatorEl?.focus();\n      }\n    }\n\n    function onActivatorKeydown(e) {\n      if (props.disabled) return;\n      const el = overlay.value?.contentEl;\n\n      if (el && isActive.value) {\n        if (e.key === 'ArrowDown') {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          focusChild(el, 'next');\n        } else if (e.key === 'ArrowUp') {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          focusChild(el, 'prev');\n        } else if (props.submenu) {\n          if (e.key === (isRtl.value ? 'ArrowRight' : 'ArrowLeft')) {\n            isActive.value = false;\n          } else if (e.key === (isRtl.value ? 'ArrowLeft' : 'ArrowRight')) {\n            e.preventDefault();\n            focusChild(el, 'first');\n          }\n        }\n      } else if (props.submenu ? e.key === (isRtl.value ? 'ArrowLeft' : 'ArrowRight') : ['ArrowDown', 'ArrowUp'].includes(e.key)) {\n        isActive.value = true;\n        e.preventDefault();\n        setTimeout(() => setTimeout(() => onActivatorKeydown(e)));\n      }\n    }\n\n    const activatorProps = computed(() => mergeProps({\n      'aria-haspopup': 'menu',\n      'aria-expanded': String(isActive.value),\n      'aria-controls': id.value,\n      onKeydown: onActivatorKeydown\n    }, props.activatorProps));\n    useRender(() => {\n      const overlayProps = VOverlay.filterProps(props);\n      return _createVNode(VOverlay, _mergeProps({\n        \"ref\": overlay,\n        \"id\": id.value,\n        \"class\": ['v-menu', props.class],\n        \"style\": props.style\n      }, overlayProps, {\n        \"modelValue\": isActive.value,\n        \"onUpdate:modelValue\": $event => isActive.value = $event,\n        \"absolute\": true,\n        \"activatorProps\": activatorProps.value,\n        \"location\": props.location ?? (props.submenu ? 'end' : 'bottom'),\n        \"onClick:outside\": onClickOutside,\n        \"onKeydown\": onKeydown\n      }, scopeId), {\n        activator: slots.activator,\n        default: function () {\n          for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n            args[_key] = arguments[_key];\n          }\n\n          return _createVNode(VDefaultsProvider, {\n            \"root\": \"VMenu\"\n          }, {\n            default: () => [slots.default?.(...args)]\n          });\n        }\n      });\n    });\n    return forwardRefs({\n      id,\n      ΨopenChildren: openChildren\n    }, overlay);\n  }\n\n});","map":{"version":3,"mappings":"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","names":["VDialogTransition","VDefaultsProvider","VOverlay","makeVOverlayProps","forwardRefs","useRtl","useProxiedModel","useScopeId","computed","inject","mergeProps","nextTick","onBeforeUnmount","onDeactivated","provide","ref","shallowRef","useId","watch","VMenuSymbol","focusableChildren","focusChild","genericComponent","getNextElement","IN_BROWSER","isClickInsideElement","omit","propsFactory","useRender","makeVMenuProps","id","String","submenu","Boolean","closeDelay","closeOnContentClick","locationStrategy","location","undefined","openDelay","scrim","scrollStrategy","transition","component","VMenu","name","props","emits","value","setup","_ref","slots","isActive","scopeId","isRtl","uid","overlay","parent","openChildren","Set","register","add","unregister","delete","closeParents","e","setTimeout","size","persistent","contentEl","document","removeEventListener","onFocusIn","before","relatedTarget","after","target","globalTop","includes","contains","focusable","focus","val","addEventListener","once","immediate","onClickOutside","onKeydown","disabled","key","HTMLTextAreaElement","HTMLInputElement","closest","preventDefault","nextElement","shiftKey","el","tabIndex","activatorEl","onActivatorKeydown","stopImmediatePropagation","activatorProps","overlayProps","filterProps","class","style","$event","activator","default","args","_key","arguments","ΨopenChildren"],"sources":["../../../src/components/VMenu/VMenu.tsx"],"sourcesContent":["// Styles\nimport './VMenu.sass'\n\n// Components\nimport { VDialogTransition } from '@/components/transitions'\nimport { VDefaultsProvider } from '@/components/VDefaultsProvider'\nimport { VOverlay } from '@/components/VOverlay'\nimport { makeVOverlayProps } from '@/components/VOverlay/VOverlay'\n\n// Composables\nimport { forwardRefs } from '@/composables/forwardRefs'\nimport { useRtl } from '@/composables/locale'\nimport { useProxiedModel } from '@/composables/proxiedModel'\nimport { useScopeId } from '@/composables/scopeId'\n\n// Utilities\nimport {\n  computed,\n  inject,\n  mergeProps,\n  nextTick,\n  onBeforeUnmount,\n  onDeactivated,\n  provide,\n  ref,\n  shallowRef,\n  useId,\n  watch,\n} from 'vue'\nimport { VMenuSymbol } from './shared'\nimport {\n  focusableChildren,\n  focusChild,\n  genericComponent,\n  getNextElement,\n  IN_BROWSER,\n  isClickInsideElement,\n  omit,\n  propsFactory,\n  useRender,\n} from '@/util'\n\n// Types\nimport type { Component } from 'vue'\nimport type { OverlaySlots } from '@/components/VOverlay/VOverlay'\n\nexport const makeVMenuProps = propsFactory({\n  // TODO\n  // disableKeys: Boolean,\n  id: String,\n  submenu: Boolean,\n\n  ...omit(makeVOverlayProps({\n    closeDelay: 250,\n    closeOnContentClick: true,\n    locationStrategy: 'connected' as const,\n    location: undefined,\n    openDelay: 300,\n    scrim: false,\n    scrollStrategy: 'reposition' as const,\n    transition: { component: VDialogTransition as Component },\n  }), ['absolute']),\n}, 'VMenu')\n\nexport const VMenu = genericComponent<OverlaySlots>()({\n  name: 'VMenu',\n\n  props: makeVMenuProps(),\n\n  emits: {\n    'update:modelValue': (value: boolean) => true,\n  },\n\n  setup (props, { slots }) {\n    const isActive = useProxiedModel(props, 'modelValue')\n    const { scopeId } = useScopeId()\n    const { isRtl } = useRtl()\n\n    const uid = useId()\n    const id = computed(() => props.id || `v-menu-${uid}`)\n\n    const overlay = ref<VOverlay>()\n\n    const parent = inject(VMenuSymbol, null)\n    const openChildren = shallowRef(new Set<string>())\n    provide(VMenuSymbol, {\n      register () {\n        openChildren.value.add(uid)\n      },\n      unregister () {\n        openChildren.value.delete(uid)\n      },\n      closeParents (e) {\n        setTimeout(() => {\n          if (!openChildren.value.size &&\n            !props.persistent &&\n            (e == null || (overlay.value?.contentEl && !isClickInsideElement(e, overlay.value.contentEl)))\n          ) {\n            isActive.value = false\n            parent?.closeParents()\n          }\n        }, 40)\n      },\n    })\n\n    onBeforeUnmount(() => {\n      parent?.unregister()\n      document.removeEventListener('focusin', onFocusIn)\n    })\n    onDeactivated(() => isActive.value = false)\n\n    async function onFocusIn (e: FocusEvent) {\n      const before = e.relatedTarget as HTMLElement | null\n      const after = e.target as HTMLElement | null\n\n      await nextTick()\n\n      if (\n        isActive.value &&\n        before !== after &&\n        overlay.value?.contentEl &&\n        // We're the topmost menu\n        overlay.value?.globalTop &&\n        // It isn't the document or the menu body\n        ![document, overlay.value.contentEl].includes(after!) &&\n        // It isn't inside the menu body\n        !overlay.value.contentEl.contains(after)\n      ) {\n        const focusable = focusableChildren(overlay.value.contentEl)\n        focusable[0]?.focus()\n      }\n    }\n\n    watch(isActive, val => {\n      if (val) {\n        parent?.register()\n        if (IN_BROWSER) {\n          document.addEventListener('focusin', onFocusIn, { once: true })\n        }\n      } else {\n        parent?.unregister()\n        if (IN_BROWSER) {\n          document.removeEventListener('focusin', onFocusIn)\n        }\n      }\n    }, { immediate: true })\n\n    function onClickOutside (e: MouseEvent) {\n      parent?.closeParents(e)\n    }\n\n    function onKeydown (e: KeyboardEvent) {\n      if (props.disabled) return\n\n      if (e.key === 'Tab' || (e.key === 'Enter' && !props.closeOnContentClick)) {\n        if (\n          e.key === 'Enter' &&\n          ((e.target instanceof HTMLTextAreaElement) ||\n          (e.target instanceof HTMLInputElement && !!e.target.closest('form')))\n        ) return\n        if (e.key === 'Enter') e.preventDefault()\n\n        const nextElement = getNextElement(\n          focusableChildren(overlay.value?.contentEl as Element, false),\n          e.shiftKey ? 'prev' : 'next',\n          (el: HTMLElement) => el.tabIndex >= 0\n        )\n        if (!nextElement) {\n          isActive.value = false\n          overlay.value?.activatorEl?.focus()\n        }\n      } else if (props.submenu && e.key === (isRtl.value ? 'ArrowRight' : 'ArrowLeft')) {\n        isActive.value = false\n        overlay.value?.activatorEl?.focus()\n      }\n    }\n\n    function onActivatorKeydown (e: KeyboardEvent) {\n      if (props.disabled) return\n\n      const el = overlay.value?.contentEl\n      if (el && isActive.value) {\n        if (e.key === 'ArrowDown') {\n          e.preventDefault()\n          e.stopImmediatePropagation()\n          focusChild(el, 'next')\n        } else if (e.key === 'ArrowUp') {\n          e.preventDefault()\n          e.stopImmediatePropagation()\n          focusChild(el, 'prev')\n        } else if (props.submenu) {\n          if (e.key === (isRtl.value ? 'ArrowRight' : 'ArrowLeft')) {\n            isActive.value = false\n          } else if (e.key === (isRtl.value ? 'ArrowLeft' : 'ArrowRight')) {\n            e.preventDefault()\n            focusChild(el, 'first')\n          }\n        }\n      } else if (\n        props.submenu\n          ? e.key === (isRtl.value ? 'ArrowLeft' : 'ArrowRight')\n          : ['ArrowDown', 'ArrowUp'].includes(e.key)\n      ) {\n        isActive.value = true\n        e.preventDefault()\n        setTimeout(() => setTimeout(() => onActivatorKeydown(e)))\n      }\n    }\n\n    const activatorProps = computed(() =>\n      mergeProps({\n        'aria-haspopup': 'menu',\n        'aria-expanded': String(isActive.value),\n        'aria-controls': id.value,\n        onKeydown: onActivatorKeydown,\n      }, props.activatorProps)\n    )\n\n    useRender(() => {\n      const overlayProps = VOverlay.filterProps(props)\n\n      return (\n        <VOverlay\n          ref={ overlay }\n          id={ id.value }\n          class={[\n            'v-menu',\n            props.class,\n          ]}\n          style={ props.style }\n          { ...overlayProps }\n          v-model={ isActive.value }\n          absolute\n          activatorProps={ activatorProps.value }\n          location={ props.location ?? (props.submenu ? 'end' : 'bottom') }\n          onClick:outside={ onClickOutside }\n          onKeydown={ onKeydown }\n          { ...scopeId }\n        >\n          {{\n            activator: slots.activator,\n            default: (...args) => (\n              <VDefaultsProvider root=\"VMenu\">\n                { slots.default?.(...args) }\n              </VDefaultsProvider>\n            ),\n          }}\n        </VOverlay>\n      )\n    })\n\n    return forwardRefs({ id, ΨopenChildren: openChildren }, overlay)\n  },\n})\n\nexport type VMenu = InstanceType<typeof VMenu>\n"]},"metadata":{},"sourceType":"module"}